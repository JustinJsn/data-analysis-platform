# 技术实现计划：Docker 部署

## 功能概述

**功能名称:** Docker 部署  
**规范版本:** 1.0  
**目标发布:** 生产环境部署

**摘要：**  
为数据分析平台实现 Docker 容器化部署方案，包括 Dockerfile、docker-compose 配置和部署文档。支持开发、测试、生产环境的统一部署流程，实现环境一致性、简化部署步骤、支持水平扩展。

---

## 宪法对齐检查

本功能必须符合 `.specify/memory/constitution.md` 中的所有原则：

- [x] **TypeScript Strict Mode:** Docker 配置文件不涉及 TypeScript 代码，但构建过程会执行类型检查
- [x] **Code Quality Gate:** Docker 构建过程会执行 `pnpm build`，其中包含 `vue-tsc -b` 类型检查
- [x] **State Management:** 不涉及状态管理变更
- [x] **Testing Discipline:** 需要添加容器化部署的 E2E 测试场景
- [x] **Production Observability:** Sentry 配置通过环境变量传入，容器化不影响现有集成

**说明：** Docker 部署主要涉及基础设施配置，不直接影响应用代码。构建过程会强制执行代码质量检查。

---

## 范围

### 包含

- Dockerfile（多阶段构建：构建阶段 + nginx 服务阶段）
- docker-compose.yml（单容器和多容器编排配置）
- .dockerignore 文件
- nginx 配置文件（SPA 路由支持、健康检查端点）
- 环境变量配置示例文件
- 部署文档和使用指南
- 健康检查脚本

### 不包含

- Kubernetes 部署配置
- CI/CD 流水线集成
- 容器镜像仓库配置
- 自动化监控和告警配置
- 后端服务容器化
- 数据库容器化

---

## 技术上下文

### 当前技术栈

- **构建工具:** Vite (Rolldown variant)
- **包管理器:** pnpm 10.x
- **构建命令:** `pnpm build`（包含 `vue-tsc -b && vite build`）
- **构建输出:** `dist/` 目录
- **应用类型:** Vue 3 SPA（单页应用）
- **环境变量:** `VITE_API_BASE_URL`（API 基础地址）

### 技术决策

1. **基础镜像选择**
   - 构建阶段：使用 `node:20-alpine`（轻量级，包含 pnpm）
   - 运行阶段：使用 `nginx:alpine`（轻量级，适合静态文件服务）

2. **构建策略**
   - 多阶段构建：分离构建环境和运行环境
   - 构建缓存：利用 Docker 层缓存优化构建速度
   - 镜像大小：目标 < 500MB

3. **Web 服务器**
   - 使用 nginx 服务静态文件
   - 配置 SPA 路由回退（所有路由指向 index.html）
   - 支持健康检查端点

4. **环境配置**
   - 使用环境变量注入运行时配置
   - 支持 .env 文件或 docker-compose 环境变量
   - 构建时注入 VITE\_\* 环境变量

5. **安全配置**
   - 以非 root 用户运行 nginx
   - 最小化暴露端口
   - 不包含敏感信息在镜像中

---

## 架构

### 组件

- **Dockerfile:** 定义镜像构建过程
  - 阶段1：构建阶段（安装依赖、构建应用）
  - 阶段2：运行阶段（nginx 服务静态文件）

- **docker-compose.yml:** 定义容器编排
  - 单容器服务配置
  - 环境变量配置
  - 端口映射
  - 健康检查配置
  - 资源限制配置

- **nginx.conf:** nginx 服务器配置
  - 静态文件服务
  - SPA 路由支持
  - 健康检查端点
  - 日志配置

- **.dockerignore:** 排除不需要的文件
  - node_modules
  - 测试文件
  - 开发配置文件

- **部署文档:** 使用指南和最佳实践

### 状态（Pinia Stores）

不涉及状态管理变更。

### 路由

不涉及路由变更，但需要 nginx 配置支持 SPA 路由回退。

---

## 测试策略

### 单元测试

不适用（基础设施配置）。

### E2E 测试

需要添加容器化部署相关的 E2E 测试场景：

- **容器构建测试：** 验证 Docker 镜像可以成功构建
- **容器启动测试：** 验证容器可以正常启动，服务可用
- **健康检查测试：** 验证健康检查端点正常工作
- **环境变量测试：** 验证环境变量正确注入
- **多实例测试：** 验证可以同时运行多个容器实例
- **SPA 路由测试：** 验证前端路由在容器中正常工作

### 手动测试清单

- [ ] 本地构建镜像并运行
- [ ] 验证应用功能在容器中正常
- [ ] 验证环境变量配置生效
- [ ] 验证健康检查端点
- [ ] 验证日志输出
- [ ] 验证资源限制生效
- [ ] 验证多实例运行
- [ ] 验证容器重启后自动恢复

---

## 可观测性

### Sentry 集成

Sentry 配置通过环境变量传入，容器化不影响现有集成：

- `VITE_SENTRY_DSN`: Sentry DSN 配置
- 错误追踪在容器中正常工作
- 日志输出到标准输出，便于容器日志收集

### 日志

- 应用日志输出到标准输出
- nginx 访问日志和错误日志配置
- 容器日志可通过 `docker logs` 查看

---

## 依赖

### 外部依赖

- **Docker:** 容器运行时环境
- **docker-compose:** 容器编排工具（可选，用于多容器场景）
- **nginx:** Web 服务器（包含在运行镜像中）

### 项目依赖

- 所有项目依赖在构建阶段安装
- 运行时仅需要 nginx 和构建产物

---

## 成功标准

- [x] 所有宪法检查通过
- [ ] Dockerfile 成功构建镜像，镜像大小 < 500MB
- [ ] 容器启动时间 < 30 秒
- [ ] 应用在容器中功能正常，与原生运行一致
- [ ] 环境变量配置生效
- [ ] 健康检查端点正常工作
- [ ] 支持多实例运行
- [ ] 容器以非 root 用户运行
- [ ] 部署文档完整清晰
- [ ] E2E 测试覆盖容器化部署场景

---

## 实施阶段

### Phase 0: 研究与设计

**任务：**

1. 研究 Vue 3 SPA 的 Docker 部署最佳实践
2. 研究 nginx SPA 路由配置
3. 研究多阶段构建优化策略
4. 研究环境变量注入方案

**输出：** `research.md`

### Phase 1: 核心文件创建

**任务：**

1. 创建 Dockerfile（多阶段构建）
2. 创建 .dockerignore
3. 创建 nginx.conf
4. 创建 docker-compose.yml
5. 创建环境变量示例文件
6. 创建健康检查脚本

**输出：** 所有 Docker 相关配置文件

### Phase 2: 文档与测试

**任务：**

1. 编写部署文档
2. 添加 E2E 测试场景
3. 验证所有功能
4. 更新 README

**输出：** 部署文档、测试用例、更新的 README

---

## 风险评估

### 技术风险

1. **镜像大小过大**
   - 风险：下载和部署时间过长
   - 缓解：使用 alpine 基础镜像，多阶段构建，清理构建缓存

2. **环境变量配置错误**
   - 风险：应用无法连接到后端 API
   - 缓解：提供清晰的配置文档和示例，添加配置验证

3. **SPA 路由问题**
   - 风险：刷新页面或直接访问路由时 404
   - 缓解：正确配置 nginx try_files 指令

4. **构建缓存失效**
   - 风险：构建时间过长
   - 缓解：优化 Dockerfile 层顺序，合理使用构建缓存

### 运维风险

1. **容器启动失败**
   - 风险：部署后服务不可用
   - 缓解：添加健康检查，提供详细的错误日志

2. **资源限制不当**
   - 风险：容器因资源不足被杀死
   - 缓解：根据实际使用情况调整资源限制，提供推荐配置

---

## 后续优化

- 支持开发环境的 Docker Compose（热重载）
- 添加 Docker 镜像多架构支持（ARM64）
- 优化构建缓存策略
- 添加镜像安全扫描
- 支持通过环境变量配置 nginx
