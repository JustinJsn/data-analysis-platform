# 任务列表：Docker 部署

**规范:** [spec.md](./spec.md)  
**计划:** [plan.md](./plan.md)  
**研究:** [research.md](./research.md)

---

## 任务概览

**总任务数:** 28  
**用户故事数:** 3  
**可并行任务:** 12

### 任务分布

- **Phase 1 (Setup):** 3 个任务
- **Phase 2 (US1 - 生产环境部署):** 8 个任务
- **Phase 3 (US2 - 本地开发环境):** 5 个任务
- **Phase 4 (US3 - 多实例扩展):** 4 个任务
- **Phase 5 (测试与验证):** 5 个任务
- **Phase 6 (文档与优化):** 3 个任务

### MVP 范围

**建议 MVP:** Phase 1 + Phase 2（US1 - 生产环境部署）

MVP 包含：

- 基础 Docker 配置文件
- 生产环境部署能力
- 基本健康检查和日志

---

## 依赖关系图

```
Phase 1 (Setup)
    ↓
Phase 2 (US1 - 生产环境部署)
    ↓
Phase 3 (US2 - 本地开发环境) ──┐
    ↓                            │
Phase 4 (US3 - 多实例扩展) ──────┤
    ↓                            │
Phase 5 (测试与验证) ─────────────┘
    ↓
Phase 6 (文档与优化)
```

**说明：**

- Phase 1 是基础，必须先完成
- Phase 2 实现核心部署功能（US1）
- Phase 3 和 Phase 4 可以并行开发（不同文件）
- Phase 5 需要所有功能完成
- Phase 6 是最后阶段

---

## 实施策略

### MVP 优先

1. **第一阶段（MVP）：** 完成 Phase 1 和 Phase 2
   - 实现基本 Docker 部署能力
   - 支持生产环境部署
   - 满足场景1的核心需求

2. **第二阶段：** 完成 Phase 3
   - 支持本地开发环境
   - 满足场景2的需求

3. **第三阶段：** 完成 Phase 4
   - 支持多实例扩展
   - 满足场景3的需求

4. **第四阶段：** 完成 Phase 5 和 Phase 6
   - 全面测试和验证
   - 完善文档

### 增量交付

每个阶段都是独立可测试的增量：

- Phase 1 + Phase 2：可以独立部署和测试
- Phase 3：可以独立使用和测试
- Phase 4：可以独立验证多实例功能
- Phase 5：全面验证所有功能
- Phase 6：完善用户体验

---

## Phase 1: Setup & 基础配置

**目标:** 准备 Docker 部署的基础文件和配置

**独立测试标准:**

- [ ] `.dockerignore` 文件存在且正确配置
- [ ] 项目根目录准备好 Docker 相关文件位置

### 任务列表

- [x] T001 创建 `.dockerignore` 文件，排除 node_modules、测试文件、开发配置文件等不需要的文件
- [x] T002 创建 `docker/` 目录用于存放 Docker 相关配置文件
- [x] T003 创建 `docker/nginx/` 目录用于存放 nginx 配置文件

---

## Phase 2: US1 - 生产环境部署

**用户故事:** 作为运维人员，我想要使用 Docker 将数据分析平台部署到生产服务器，以便于快速、可靠地完成部署，并确保生产环境与测试环境一致

**优先级:** P1

**独立测试标准:**

- [ ] 可以通过 `docker build` 成功构建镜像
- [ ] 可以通过 `docker run` 启动容器
- [ ] 容器启动后应用在 30 秒内可用
- [ ] 健康检查端点 `/health` 返回 200
- [ ] 应用功能在容器中正常运行
- [ ] 镜像大小 < 500MB
- [ ] 容器以非 root 用户运行

### 任务列表

- [x] T004 [US1] 创建 `Dockerfile`，实现多阶段构建：构建阶段使用 `node:20-alpine`，运行阶段使用 `nginx:alpine`
- [x] T005 [US1] 在 Dockerfile 构建阶段安装 pnpm（使用 corepack），复制 package.json 和 pnpm-lock.yaml，安装依赖
- [x] T006 [US1] 在 Dockerfile 构建阶段复制源代码，设置构建时环境变量（ARG/ENV），执行 `pnpm build`
- [x] T007 [US1] 在 Dockerfile 运行阶段从构建阶段复制 `dist/` 目录到 nginx html 目录
- [x] T008 [US1] 创建 `docker/nginx/nginx.conf`，配置静态文件服务、SPA 路由回退（try_files）、Gzip 压缩
- [x] T009 [US1] 在 nginx.conf 中添加 `/health` 健康检查端点，返回 200 状态码
- [x] T010 [US1] 在 Dockerfile 中配置 nginx 日志输出到标准输出/错误（access_log /dev/stdout, error_log /dev/stderr）
- [x] T011 [US1] 在 Dockerfile 中创建非 root 用户，修改文件所有权，配置容器以非 root 用户运行

### 并行执行示例

以下任务可以并行执行（不同文件，无依赖）：

- T008, T009, T010（nginx 配置相关，可以一起完成）

---

## Phase 3: US2 - 本地开发环境

**用户故事:** 作为开发人员，我想要使用 Docker 在本地运行数据分析平台，以便于快速搭建开发环境，无需手动安装和配置各种依赖

**优先级:** P2

**依赖:** Phase 2 完成

**独立测试标准:**

- [ ] 可以通过 `docker-compose up` 启动服务
- [ ] 应用在本地容器中运行正常
- [ ] 环境变量配置生效
- [ ] 容器日志清晰可读
- [ ] 本地环境可以在 3 分钟内启动

### 任务列表

- [x] T012 [US2] 创建 `docker-compose.yml`，定义应用服务，配置端口映射（8080:80）
- [x] T013 [US2] 在 docker-compose.yml 中配置环境变量（VITE_API_BASE_URL 等），支持从 .env 文件读取
- [x] T014 [US2] 在 docker-compose.yml 中配置健康检查（使用 /health 端点）
- [x] T015 [US2] 创建 `.env.example` 文件，包含所有必需和可选环境变量的示例配置
- [x] T016 [US2] 在 docker-compose.yml 中配置资源限制（内存 512M，CPU 1 核）

### 并行执行示例

以下任务可以并行执行：

- T012, T013, T014, T016（docker-compose.yml 的不同部分，可以一起编辑）
- T015（独立的示例文件）

---

## Phase 4: US3 - 多实例扩展

**用户故事:** 作为系统管理员，我想要根据用户访问量动态调整应用实例数量，以便于应对流量高峰，保证系统性能和可用性

**优先级:** P3

**依赖:** Phase 2 完成

**独立测试标准:**

- [ ] 可以同时运行多个容器实例
- [ ] 多个实例使用不同端口映射
- [ ] 实例之间无资源冲突
- [ ] 支持至少 10 个并发实例
- [ ] 新增实例可以在 2 分钟内启动

### 任务列表

- [x] T017 [US3] 在 docker-compose.yml 中添加多实例配置示例（使用 scale 或多个服务定义）
- [x] T018 [US3] 创建 `docker-compose.prod.yml` 用于生产环境多实例部署，配置资源限制和重启策略
- [x] T019 [US3] 在 docker-compose.prod.yml 中配置多个服务实例，每个实例使用不同的端口映射（8080-8089:80）
- [ ] T020 [US3] 验证多实例配置，确保实例之间可以独立运行，无端口冲突（需要手动验证）

### 并行执行示例

以下任务可以并行执行：

- T017, T018（不同的 compose 文件）

---

## Phase 5: 测试与验证

**目标:** 全面测试 Docker 部署功能，确保所有场景正常工作

**依赖:** Phase 2, Phase 3, Phase 4 完成

**独立测试标准:**

- [ ] 所有 E2E 测试通过
- [ ] 容器构建测试通过
- [ ] 容器启动测试通过
- [ ] 健康检查测试通过
- [ ] 环境变量测试通过
- [ ] 多实例测试通过
- [ ] SPA 路由测试通过

### 任务列表

- [x] T021 创建 E2E 测试文件 `tests/e2e/docker-build.spec.ts`，测试 Docker 镜像构建
- [x] T022 创建 E2E 测试文件 `tests/e2e/docker-run.spec.ts`，测试容器启动、健康检查、应用功能
- [x] T023 创建 E2E 测试文件 `tests/e2e/docker-env.spec.ts`，测试环境变量注入和配置
- [x] T024 创建 E2E 测试文件 `tests/e2e/docker-multi-instance.spec.ts`，测试多实例运行
- [ ] T025 执行手动测试清单：验证所有验收标准，包括镜像大小、启动时间、资源限制等（需要手动执行）

### 并行执行示例

以下任务可以并行执行（不同的测试文件）：

- T021, T022, T023, T024

---

## Phase 6: 文档与优化

**目标:** 完善部署文档，优化配置，确保部署体验良好

**依赖:** Phase 5 完成

**独立测试标准:**

- [ ] 部署文档完整清晰
- [ ] 新运维人员可以按照文档独立完成部署
- [ ] README 包含 Docker 部署说明
- [ ] 所有配置优化完成

### 任务列表

- [x] T026 更新项目根目录 `README.md`，添加 Docker 部署章节，包含快速开始、环境配置、常见问题
- [x] T027 创建 `docs/docker-deployment.md` 详细部署文档，包含生产环境部署、多实例部署、故障排查、最佳实践
- [x] T028 优化 Dockerfile 构建缓存策略，确保依赖变更时缓存有效，代码变更时快速重建（已优化：先复制 package.json 和 pnpm-lock.yaml 安装依赖，再复制源代码构建）

### 并行执行示例

以下任务可以并行执行（不同的文档文件）：

- T026, T027

---

## 并行执行机会

### 高并行度阶段

**Phase 2 (US1):**

- T008, T009, T010 可以并行（nginx 配置的不同部分）

**Phase 3 (US2):**

- T012, T013, T014, T016 可以并行（docker-compose.yml 的不同部分）
- T015 独立执行

**Phase 4 (US3):**

- T017, T018 可以并行（不同的 compose 文件）

**Phase 5 (测试):**

- T021, T022, T023, T024 可以并行（不同的测试文件）

**Phase 6 (文档):**

- T026, T027 可以并行（不同的文档文件）

### 建议执行顺序

1. **串行执行：** Phase 1 → Phase 2（核心功能）
2. **并行执行：** Phase 3 和 Phase 4 可以并行开发
3. **串行执行：** Phase 5（需要所有功能完成）
4. **并行执行：** Phase 6（文档可以并行编写）

---

## 任务完成标准

每个任务完成时需满足：

1. **功能实现：** 代码/配置实现指定功能
2. **格式检查：** 通过 oxlint 和 oxfmt（如适用）
3. **类型检查：** TypeScript 代码通过 vue-tsc（如适用）
4. **文档更新：** 相关文档已更新
5. **测试验证：** 手动测试或自动化测试通过

### Phase 完成标准

每个 Phase 完成时需满足：

1. **所有任务完成：** Phase 内所有任务标记为完成
2. **独立测试通过：** Phase 的独立测试标准全部满足
3. **验收标准：** 相关用户故事的验收标准满足（如适用）

---

## 宪法原则映射

| 任务类别    | 原则                   | 验证方式                           |
| ----------- | ---------------------- | ---------------------------------- |
| Docker 配置 | P2: Code Quality Gate  | 配置文件格式正确，无语法错误       |
| 构建过程    | P1: TypeScript Strict  | 构建过程执行 `vue-tsc -b` 类型检查 |
| 测试        | P4: Testing Discipline | E2E 测试覆盖所有部署场景           |
| 可观测性    | P5: Observability      | 日志输出到标准输出，健康检查配置   |
| 文档        | -                      | 部署文档完整清晰                   |

---

## 定义完成（Definition of Done）

整个功能完成时需满足：

1. ✅ 所有任务完成
2. ✅ 所有用户故事验收标准满足
3. ✅ 所有 E2E 测试通过
4. ✅ 手动测试清单全部通过
5. ✅ 部署文档完整清晰
6. ✅ 镜像大小 < 500MB
7. ✅ 容器启动时间 < 30 秒
8. ✅ 健康检查通过率 ≥ 99%
9. ✅ 支持多实例运行（至少 10 个）
10. ✅ 容器以非 root 用户运行
11. ✅ 所有宪法原则满足

---

## 注意事项

- **环境变量：** 确保敏感信息（如 API 密钥）不硬编码在镜像中
- **构建缓存：** 优化 Dockerfile 层顺序，最大化利用构建缓存
- **镜像大小：** 使用多阶段构建和 alpine 镜像，确保镜像大小 < 500MB
- **安全配置：** 始终以非 root 用户运行容器
- **日志管理：** 确保所有日志输出到标准输出/错误，便于容器日志收集
- **健康检查：** 配置合适的健康检查间隔和超时时间
- **资源限制：** 根据实际使用情况调整资源限制，避免资源浪费

---

## 下一步

1. 开始执行 Phase 1 任务
2. 完成 MVP（Phase 1 + Phase 2）
3. 逐步完成后续阶段
4. 使用 `/speckit.implement` 开始实施
